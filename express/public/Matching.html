<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Raymoch • Matching</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- =======================================================
       RAYMOCH • MATCHING (Canonical header/footer like Services.html)
       ======================================================= -->
  <style>
    /* =========================================================
       RAYMOCH COLOR SYSTEM — MASTER TOKENS (GLOBAL DEFAULTS)
       (Copied from landing/Services to guarantee consistency)
       ========================================================= */
    :root{
      --brand-blue:#0328aeed;
      --brand-blue-700:#213bb1;
      --brand-blue-500:#041b64;
      --accent-gold:#7a7797a8;

      --ink:#101114;
      --muted:#3c4b69;
      --bg:#fafafa;        /* light page background */
      --border:#e8e8ee;
      --card:#ffffff;

      --radius:14px; --pill:999px;
      --shadow:0 6px 22px rgba(10,42,107,.08);
      --maxw:1328px; --gutter:18px;

      --footer-bg:#0b1020; /* single source of truth */

      /* Page-specific hero variables you were using */
      --hero-bg:#535ca237;
      --hero-fg:#0d0d0f;
      --hero-border:#ccd1db;
      --hero-radius:16px;
      --hero-pad:36px;
      --hero-pad-x:60px;
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif}

    /* ========= Canvas + Overscroll fixes (no white under footer) ========= */
    html{
      background:var(--footer-bg);           /* canvas matches footer */
      height:100%;
    }
    body{
      color:var(--ink);
      line-height:1.5;
      min-height:100dvh;
      display:flex;
      flex-direction:column;
      overscroll-behavior-y:none;            /* stop bounce on modern engines */

      /* Light page → fades to footer color near the bottom.
         This masks iOS rubber-band past the end. */
      background:
        linear-gradient(to bottom,
          var(--bg) 0%,
          var(--bg) calc(100% - 240px),
          var(--footer-bg) calc(100% - 240px),
          var(--footer-bg) 100%);
    }
    /* iOS safe-area guard so the very bottom sliver stays dark too */
    body::after{
      content:"";
      position:fixed;
      inset:auto 0 0 0;
      height:env(safe-area-inset-bottom, 0);
      background:var(--footer-bg);
      pointer-events:none;
      z-index:1;
    }

    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:0 var(--gutter)}
    main{flex:1}

    /* ===================== HEADER (Tier1 + Tier2) — IDENTICAL TO Services.html ===================== */
    .header{
      --nav-brand: var(--brand-blue);
      --nav-link:  #0f172a;
      --nav-hover: #0a2a6b;
      --nav-bg:    #ffffff;
      --nav-fg:    var(--ink);
      background: var(--nav-bg); color: var(--nav-fg);
      position:sticky;top:0;z-index:1000;border-bottom:1px solid var(--border)
    }
    .row1{
      display:flex;justify-content:space-between;align-items:center;gap:16px;
      padding:12px 8px; margin:15px; box-shadow:0 1px 0 rgba(0,0,0,.05);
      position:relative;
      background:#fff; border-radius:12px;
    }
    .brandrow{display:flex;align-items:center;gap:22px}
    .brand{display:flex;align-items:center;gap:10px;color:var(--nav-brand)}
    .brand-word{font-weight:900;font-size:1.4rem;color:var(--nav-brand);letter-spacing:.2px}
    .dotgrid{width:18px;height:18px;display:inline-grid;grid-template-columns:repeat(2,1fr);gap:2px}
    .dotgrid i{width:5px;height:5px;border-radius:2px;background:#101114}
    .rightside{display:flex;align-items:center;gap:14px;margin-right:0}
    .search-box{min-width:140px;width:18vw;max-width:260px}
    .search-box input{width:100%;height:40px;padding:0 14px;border:1px solid var(--border);border-radius:var(--pill)}
    .search-box input:focus{border-color:var(--nav-brand);outline:2px solid #cfe0ff}
    .auth{display:flex;align-items:center;gap:10px}
    .btn{height:40px;display:inline-flex;align-items:center;gap:8px;padding:0 16px;border-radius:var(--pill);font-weight:700;background:#fff;border:1px solid var(--border)}
    .btn.primary{background:var(--nav-brand);color:#fff;border-color:var(--nav-brand)}

    .explore-toggle{
      appearance:none;border:0;background:transparent;cursor:pointer;
      display:flex;align-items:center;gap:8px;font-weight:800;color:var(--nav-link);padding:6px 8px;border-radius:8px;font-size:1.1rem;
    }
    .explore-toggle:hover,
    .explore-toggle[aria-expanded="true"]{ background:#eceff3;color:var(--nav-hover); }

    .menu-panel{
      position:absolute; top:calc(100% + 10px); left:15px; z-index:1100;
      width:min(760px, calc(100vw - 40px));
      background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);
      padding:14px;
    }
    .menu-panel[hidden]{ display:none; }
    .menu-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .menu-head h4{margin:0;font-size:1rem}
    .menu-grid{display:grid;grid-template-columns:repeat(2,minmax(240px,1fr));gap:12px}
    .menu-item{display:block;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;}
    .menu-item:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .menu-item h5{margin:0 0 6px;font-size:.98rem}
    .menu-item p{margin:0;color:var(--muted);font-size:.92rem}

    .row2{background:#f5f6f8;border-top:1px solid #eee;border-bottom:1px solid #e6e6e6;padding-left:15px}
    .row2 .wrap{max-width:none;padding:0}
    .row2 .links{display:flex;gap:18px;padding:8px 8px;margin:0;justify-content:flex-start;align-items:center}
    .row2 a{font-weight:600;font-size:.92rem;padding:4px 6px;border-radius:4px;color:var(--nav-link)}
    .row2 a:hover{background:#eceff3;color:var(--nav-hover)}
    @media (max-width:800px){ .search-box{width:34vw;max-width:300px} }
    @media (max-width:720px){ .row2{display:none} .search-box{min-width:0;width:46vw} }

    .header a:focus-visible, .header button:focus-visible, .btn:focus-visible {
      outline: 2px solid #cfe0ff; outline-offset: 2px;
    }

    /* ===================== PAGE CONTENT (your original styles) ===================== */
    .container{max-width:1100px;margin:0 auto;padding:24px}
    main .btn{border:0;background:var(--brand-blue);color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    main .btn.secondary{background:#fff;color:var(--brand-blue);border:1px solid var(--brand-blue)}

    .hero{
      background:var(--hero-bg);
      color:var(--hero-fg);
      border:1px solid var(--hero-border);
      border-radius:var(--hero-radius);
      padding:var(--hero-pad) var(--hero-pad-x);
      box-shadow:var(--shadow);
      margin-top:22px;
    }
    .hero h2{font-size:32px;margin:0 0 10px;font-weight:800;letter-spacing:.2px}
    .hero p{opacity:.95;margin:0;max-width:720px}

    .input, select{border:1px solid var(--border);background:#fff;border-radius:12px;padding:12px 14px;font-size:15px;min-width:180px}
    .row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .step{margin-top:22px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);scroll-margin-top:80px}
    .step header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .step header h3{margin:0;font-size:18px}
    .step .body{padding:18px}
    .actions{display:flex;justify-content:space-between;align-items:center;padding:16px 18px;border-top:1px solid var(--border)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .col-7{grid-column:span 7}
    .col-5{grid-column:span 5}
    .col-12{grid-column:span 12}
    .card{border:1px solid var(--border);border-radius:20px;background:#fff;padding:16px 18px;box-shadow:var(--shadow)}
    .biz-head{display:flex;justify-content:space-between;gap:10px}
    .biz-title{font-weight:800}
    .muted{color:var(--muted)}
    .badge{display:inline-block;border-radius:10px;padding:4px 8px;background:#F2F4F8;border:1px solid #E2E6EE;font-size:12px;margin-right:6px}
    .badge.green{background:#E8F7EF;border-color:#D2F0DE;color:#1A7F45}
    .mini .biz-title{font-weight:700;font-size:15px}
    .mini.card{cursor:pointer}
    .why{color:#475569;font-size:14px;margin-top:8px}
    .hint{color:var(--muted);font-size:13px}
    .count{font-weight:700}
    .hidden{display:none}
    @media (max-width:900px){
      .grid{grid-template-columns:1fr}
      .col-7,.col-5{grid-column:span 12}
    }
    button:focus,.mini.card:focus,.card[role="button"]:focus{ outline:2px solid var(--brand-blue);outline-offset:2px }

    /* ================= FOOTER (IDENTICAL TO Services.html) ================= */
    footer{margin-top:auto;background:var(--footer-bg);color:#cbd5e1;}
    @media (max-width: 860px){
      footer .wrap > div[style*="grid-template-columns"]{
        display:grid;grid-template-columns:1fr;gap:16px !important;
      }
    }
  </style>
</head>
<body>

  <!-- ================= HEADER (canonical like Services.html) ================= -->
  <header class="header" id="nav" data-version="HeaderFooter_v1.0">
    <div class="row1">
      <div class="brandrow">
        <a class="brand" href="Entire.html" aria-label="Raymoch home">
          <svg width="28" height="28" viewBox="0 0 200 200" aria-hidden="true">
            <polygon fill="none" stroke="currentColor" stroke-width="10" points="100,18 172,59 172,141 100,182 28,141 28,59"/>
            <text x="100" y="118" text-anchor="middle" style="fill:currentColor;font:700 105px Georgia">R</text>
          </svg>
          <span class="brand-word">Raymoch</span>
        </a>

        <button class="explore-toggle" id="exploreToggle" aria-haspopup="true" aria-expanded="false" aria-controls="t1Menu">
          <span class="dotgrid" aria-hidden="true"><i></i><i></i><i></i><i></i></span>
          Explore
        </button>

        <div class="menu-panel" id="t1Menu" role="menu" aria-labelledby="exploreToggle" hidden>
          <div class="menu-head"><h4>Explore services</h4></div>
          <div class="menu-grid">
            <a class="menu-item" role="menuitem" href="Matching.html"><h5>Trusted Matching</h5><p>Get paired with credible businesses using CTI & verification.</p></a>
            <a class="menu-item" role="menuitem" href="verification.html"><h5>Verification</h5><p>CTI badges, document checks, and data provenance.</p></a>
            <a class="menu-item" role="menuitem" href="Market_Insight.html"><h5>Research & Insights</h5><p>Sector reports, trends, and regional briefs.</p></a>
            <a class="menu-item" role="menuitem" href="Services.html"><h5>Programs & Services</h5><p>Advisory, partner programs, and support options.</p></a>
            <a class="menu-item" role="menuitem" href="incentives.html"><h5>Policy & Incentives</h5><p>Tax credits, grants, and regulatory signals.</p></a>
            <a class="menu-item" role="menuitem" href="whitespace.html"><h5>Whitespace Map</h5><p>Where demand outpaces supply across sectors.</p></a>
          </div>
        </div>
      </div>

      <div class="rightside">
        <form class="search-box" action="search.html">
          <input type="search" name="q" placeholder="Search companies, sectors, regions…" />
        </form>
        <div class="auth">
          <a class="btn" href="login.html">Log in</a>
          <a class="btn primary" href="signup.html">Sign up</a>
        </div>
      </div>
    </div>

    <div class="row2">
      <div class="wrap">
        <nav class="links" aria-label="Secondary">
          <a href="explore2.html">Businesses</a>
          <a href="Services.html">Services</a>
          <a href="Market_Insight.html">Research &amp; Insights</a>
          <a href="About.html">Who We Are</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- ===================== MAIN (your Matching UI) ===================== -->
  <main>
    <div class="container">

      <!-- HERO -->
      <section class="hero" id="heroCard">
        <h2>Match With The Right African SMEs</h2>
        <p><!-- Intentionally blank; add a one-liner if needed. --></p>
      </section>

      <!-- ========== STEP: Search & Refine ========== -->
      <section class="step" id="searchStep">
        <header>
          <h3>Search & Refine</h3>
          <span class="hint"><span class="count" id="matchCountTop" aria-live="polite">0</span> businesses match your current filters</span>
        </header>
        <div class="body">
          <div class="grid">
            <!-- Filters -->
            <div class="col-7 card">
              <h4 style="margin:0 0 10px">Filters</h4>
              <div class="row">
                <input id="q2" class="input" placeholder="Search by name, city, keyword…" aria-label="Keyword search" />
                <select id="country2" class="input" aria-label="Country"></select>
                <select id="sector2" class="input" aria-label="Sector">
                  <option value="">All sectors</option>
                </select>
              </div>
              <div class="row" style="margin-top:10px">
                <input id="min2" class="input" type="number" placeholder="Min ticket ($)" aria-label="Minimum ticket" />
                <input id="max2" class="input" type="number" placeholder="Max ticket ($)" aria-label="Maximum ticket" />
                <select id="cti" class="input" aria-label="CTI depth">
                  <option value="">Any CTI depth</option>
                  <option value="existence">Existence Only</option>
                  <option value="verified">Verified</option>
                  <option value="deep">Deep CTI</option>
                </select>
              </div>
              <div id="rangeWarn" class="hint" aria-live="polite"></div>
              <div class="row" style="margin-top:10px">
                <label class="pill"><input type="checkbox" value="equity" class="instr" /> Equity</label>
                <label class="pill"><input type="checkbox" value="revenue share" class="instr" /> Revenue share</label>
                <label class="pill"><input type="checkbox" value="debt" class="instr" /> Debt</label>
                <label class="pill"><input type="checkbox" value="grant" class="instr" /> Grant</label>
              </div>
              <div class="row" style="margin-top:12px">
                <button class="btn" id="doMatch">Match</button>
                <span class="hint">Preview updates live. Click a preview card to open the profile.</span>
              </div>
            </div>

            <!-- Preview -->
            <div class="col-5">
              <div class="card">
                <div class="row" style="justify-content:space-between;align-items:center">
                  <h4 style="margin:0">Preview</h4>
                  <div class="seg" role="tablist" aria-label="Preview mode">
                    <button class="active" id="segSuggested" role="tab" aria-selected="true" aria-controls="miniPreview">Suggested</button>
                    <button id="segLatest" role="tab" aria-selected="false" aria-controls="miniPreview">Latest</button>
                  </div>
                </div>
                <div id="miniPreview" style="margin-top:6px"></div>
                <div class="hint" style="margin-top:8px">You’ll see the full list on the next step.</div>
              </div>
            </div>
          </div>

          <div style="margin-top:16px" class="row">
            <button class="btn secondary" id="toMatches">Continue</button>
          </div>
        </div>
        <div class="actions">
          <span class="hint">Preview: <span class="count" id="matchCountBottom" aria-live="polite">0</span> potential matches.</span>
        </div>
      </section>

      <!-- ========== STEP: Matches ========== -->
      <section class="step hidden" id="matchStep">
        <header>
          <h3>Matched businesses</h3>
          <span class="hint" id="showingText" aria-live="polite">Showing 0 of 0</span>
        </header>
        <div class="body" id="results"></div>
        <div class="actions">
          <button class="btn secondary" id="backToSearch">Back</button>
          <span style="flex:1"></span>
          <button class="btn" id="continueCTA">Continue</button>
        </div>
      </section>

      <!-- ========== STEP: Company Profile ========== -->
      <section class="step hidden" id="profileStep">
        <header>
          <h3 id="profName">Company</h3>
          <span class="hint" id="profMeta"></span>
        </header>
        <div class="body" id="profBody"></div>
        <div class="actions">
          <button class="btn secondary" id="backFromProfile">Back</button>
          <span style="flex:1"></span>
          <button class="btn" id="contactCTA">Contact</button>
        </div>
      </section>
    </div>
  </main>

  <!-- ================= FOOTER (canonical like Services.html) ================= -->
  <footer>
    <div class="wrap" style="padding:32px var(--gutter)">
      <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:18px">
        <div>
          <div style="color:#fff;font-weight:800;font-size:1.2rem;margin-bottom:8px">Raymoch</div>
          <div style="color:#94a3b8;max-width:360px">
            Connecting investors and entrepreneurs through trust, verified data, and actionable insights.
          </div>
        </div>
        <div>
          <h5 style="margin-bottom:10px;color:#e5e7eb;font-size:.95rem">Company</h5>
          <a href="About.html" style="display:block;color:#cbd5e1;margin:6px 0">About</a>
          <a href="careers.html" style="display:block;color:#cbd5e1;margin:6px 0">Careers</a>
          <a href="press.html" style="display:block;color:#cbd5e1;margin:6px 0">Press</a>
          <a href="contact.html" style="display:block;color:#cbd5e1;margin:6px 0">Contact</a>
        </div>
        <div>
          <h5 style="margin-bottom:10px;color:#e5e7eb;font-size:.95rem">Product</h5>
          <a href="explore2.html" style="display:block;color:#cbd5e1;margin:6px 0">Explore Businesses</a>
          <a href="Market_Insight.html" style="display:block;color:#cbd5e1;margin:6px 0">Market Insights</a>
          <a href="verification.html" style="display:block;color:#cbd5e1;margin:6px 0">Verification</a>
          <a href="Services.html" style="display:block;color:#cbd5e1;margin:6px 0">Programs & Services</a>
        </div>
        <div>
          <h5 style="margin-bottom:10px;color:#e5e7eb;font-size:.95rem">Resources</h5>
          <a href="blog.html" style="display:block;color:#cbd5e1;margin:6px 0">Blog</a>
          <a href="help.html" style="display:block;color:#cbd5e1;margin:6px 0">Help Center</a>
          <a href="security.html" style="display:block;color:#cbd5e1;margin:6px 0">Security</a>
          <a href="status.html" style="display:block;color:#cbd5e1;margin:6px 0">Status</a>
        </div>
      </div>
      <div style="border-top:1px solid #1f2937;margin-top:22px;padding:12px 0;display:flex;justify-content:space-between;align-items:center;font-size:.92rem">
        <!-- NOTE: Services.html version uses static year "© 2025" — matching that exactly -->
        <div>© 2025 Raymoch. All rights reserved.</div>
        <div>
          <a href="privacy.html" style="color:#cbd5e1;margin-left:14px">Privacy</a>
          <a href="terms.html" style="color:#cbd5e1;margin-left:14px">Terms</a>
          <a href="cookies.html" style="color:#cbd5e1;margin-left:14px">Cookies</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- ================= JS (IDENTICAL HEADER BEHAVIOR AS Services.html) ================= -->
  <script>
    /* Tier-1 Explore menu toggle */
    (() => {
      const btn = document.getElementById('exploreToggle');
      const menu = document.getElementById('t1Menu');
      if (!btn || !menu) return;
      const openMenu = (on) => { btn.setAttribute('aria-expanded', on ? 'true' : 'false'); menu.hidden = !on; };
      btn.addEventListener('click', (e) => { e.preventDefault(); openMenu(btn.getAttribute('aria-expanded') !== 'true'); });
      document.addEventListener('click', (e) => { if (!menu.hidden && !menu.contains(e.target) && !btn.contains(e.target)) openMenu(false); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') openMenu(false); });
    })();

    /* A11y roles for menu items */
    (() => {
      const menu = document.getElementById('t1Menu');
      menu?.querySelectorAll('a.menu-item').forEach(a => a.setAttribute('role','menuitem'));
    })();
  </script>

  <!-- Dataset (unchanged) -->
  <script src="companies.js?v=20251009a"></script>

  <!-- ===== Matching logic (your original; no duplicate sniffers) ===== -->
  <script>
    function sniffCompaniesGlobal() {
      const candidates = [
        'COMPANIES','companies','Companies','DATASET','dataset','data','COMPANY_LIST','companyList'
      ].map(k => [k, window[k]]).filter(([,v]) => Array.isArray(v) && v.length);
      if (candidates.length) {
        candidates.sort((a,b)=>{
          const score = v => {
            const x = v[1][0] || {};
            let s = 0;
            if ('name' in x || 'company_name' in x || 'title' in x) s += 2;
            if ('sector' in x || 'industry' in x || 'category' in x) s += 2;
            if ('country' in x || 'hq_country' in x) s += 1;
            return s;
          };
          return score(b)-score(a);
        });
        const [key, val] = candidates[0];
        console.info('[Matching] Found candidate global:', key, 'len=', val.length);
        return val;
      }
      return null;
    }

    const pick = (obj, keys, fallback='')=>{
      for (const k of keys){ if (obj && obj[k] != null && obj[k] !== '') return obj[k]; }
      return fallback;
    };
    function adaptCompaniesToData(list){
      return list.map(c=>{
        const min = Number(pick(c, ['min_ticket_usd','ticket_min','min','investment_min'], 0)) || 0;
        const max = Number(pick(c, ['max_ticket_usd','ticket_max','max','investment_max'], 999999999)) || 999999999;
        const instRaw = pick(c, ['instruments','acceptable_instruments','accepts'], []);
        const inst = Array.isArray(instRaw) ? instRaw : String(instRaw).split(',').map(s=>s.trim()).filter(Boolean);
        const ctiRaw = (pick(c, ['cti_depth','verification_status','cti'], '')||'').toString().toLowerCase();
        const cti = ctiRaw.includes('deep') ? 'deep' : ctiRaw.includes('verify') ? 'verified' : (ctiRaw ? 'existence' : 'existence');
        const updatedAgo = Number(pick(c, ['updated_days_ago','freshnessDays','updated_ago_days'], 30)) || 30;
        const code = pick(c, ['company_code','code','id'], '');

        return {
          name: pick(c, ['name','company_name','title'], 'Untitled Co.'),
          country: pick(c, ['country','hq_country'], ''),
          sector: pick(c, ['sector','industry','category'], ''),
          min, max,
          accepts: inst.length ? inst : ['equity'],
          cti,
          freshnessDays: updatedAgo,
          fit: 'Good fit',
          why: ['sector match','ticket band ok'],
          about: pick(c, ['about','description','summary'], '—'),
          needs: pick(c, ['needs','capital_needs','use_of_funds'], '—'),
          links: {
            site: pick(c, ['website','site','url'], '#'),
            deck: pick(c, ['deck_url','pitch_url','data_room'], '#'),
            profile: code ? `company.html?code=${encodeURIComponent(code)}` : ''
          }
        };
      });
    }

    const AU_COUNTRIES = [
      "Algeria","Angola","Benin","Botswana","Burkina Faso","Burundi","Cabo Verde","Cameroon",
      "Central African Republic","Chad","Comoros","Congo (Republic)","Congo (Democratic Republic)",
      "Côte d’Ivoire","Djibouti","Egypt","Equatorial Guinea","Eritrea","Eswatini","Ethiopia","Gabon",
      "Gambia","Ghana","Guinea","Guinea-Bissau","Kenya","Lesotho","Liberia","Libya","Madagascar",
      "Malawi","Mali","Mauritania","Mauritius","Morocco","Mozambique","Namibia","Niger","Nigeria",
      "Rwanda","Sahrawi Arab Democratic Republic","São Tomé and Príncipe","Senegal","Seychelles",
      "Sierra Leone","Somalia","South Africa","South Sudan","Sudan","Tanzania","Togo","Tunisia",
      "Uganda","Zambia","Zimbabwe"
    ];

    const STUB_DATA = [
      { name:"Shashamane Agro Co.", country:"Ethiopia", sector:"Agriculture & Food", min:15000, max:80000, accepts:["revenue share","equity"], cti:"verified", freshnessDays:21, fit:"Great fit", why:["ticket aligned","instrument match","timing ok","preferred sector","ready soon"], about:"Regional agro-processing firm focused on grain and oilseeds. Strong local supply relationships.", needs:"Working capital + small-scale equipment upgrades.", links:{site:"#", deck:"#", profile:""} },
      { name:"LipaLink", country:"Kenya", sector:"FinTech", min:25000, max:120000, accepts:["equity","debt"], cti:"existence", freshnessDays:14, fit:"Good fit", why:["ticket aligned","sector focus"], about:"Payments aggregator for SMEs bridging mobile money and bank rails.", needs:"Seed extension.", links:{site:"#", deck:"#", profile:""} },
      { name:"SunBloom Energy", country:"Rwanda", sector:"Energy & Renewables", min:50000, max:200000, accepts:["equity","revenue share"], cti:"deep", freshnessDays:3, fit:"Great fit", why:["timing ok","impact aligned","CTI depth"], about:"C&I solar EPC with recurring O&M contracts.", needs:"Project finance for 1.2MW pipeline.", links:{site:"#", deck:"#", profile:""} },
      { name:"Medura Clinics", country:"Ghana", sector:"Health", min:10000, max:60000, accepts:["revenue share"], cti:"verified", freshnessDays:33, fit:"Possible match", why:["early pipeline"], about:"Primary care clinics expanding to peri-urban areas.", needs:"Equipment leasing + short-term WC.", links:{site:"#", deck:"#", profile:""} }
    ];

    (function bootData(){
      if (typeof window.COMPANIES === 'undefined') {
        const sniffed = sniffCompaniesGlobal();
        if (sniffed) window.COMPANIES = sniffed;
      }
      if (Array.isArray(window.COMPANIES) && window.COMPANIES.length) {
        console.info('[Matching] Using REAL dataset from companies.js — length:', window.COMPANIES.length);
        window.DATA = adaptCompaniesToData(window.COMPANIES);
      } else {
        console.warn('[Matching] Real dataset not found. Falling back to STUB.');
        window.DATA = STUB_DATA;
      }
    })();

    function populateCountries(){
      const sel = document.querySelector('#country2'); if(!sel) return;
      sel.innerHTML = `<option value="">All countries (${AU_COUNTRIES.length})</option>` +
        AU_COUNTRIES.map(c => `<option>${c}</option>`).join('');
    }
    function populateSectors(){
      const sel = document.querySelector('#sector2'); if(!sel) return;
      const sectors = Array.from(new Set((window.DATA||[]).map(d=>d.sector).filter(Boolean))).sort();
      const opts = [`<option value="">All sectors</option>`].concat(sectors.map(s=>`<option>${s}</option>`));
      sel.innerHTML = opts.join('');
    }
    populateCountries();
    populateSectors();

    const $ = s => document.querySelector(s);
    const on = (sel, evt, fn) => { const el = (typeof sel==='string') ? $(sel) : sel; if(el) el.addEventListener(evt, fn); };
    const moneyFmt = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
    const money = n => moneyFmt.format(n);
    const debounce = (fn, ms=150) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

    function getFilters(){
      const kw = ($('#q2')?.value || '').trim().toLowerCase();
      const country = $('#country2')?.value || '';
      const sector = $('#sector2')?.value || '';
      let min = parseInt($('#min2')?.value || '0',10);
      let max = parseInt($('#max2')?.value || '999999999',10);
      if (Number.isNaN(min)) min = 0;
      if (Number.isNaN(max)) max = 999999999;

      const warn = $('#rangeWarn');
      if (min > max){
        [min,max] = [max,min];
        if (warn) warn.textContent = 'Swapped ticket range to make sense.';
      } else if (warn) warn.textContent = '';

      const cti = $('#cti')?.value || '';
      const instr = [...document.querySelectorAll('.instr:checked')].map(x=>x.value);
      return {kw,country,sector,min,max,cti,instr};
    }

    const passes = (d,f) => {
      if (f.kw){
        const hay = `${d.name} ${d.country} ${d.sector}`.toLowerCase();
        if (!hay.includes(f.kw)) return false;
      }
      if (f.country && d.country!==f.country) return false;
      if (f.sector && d.sector!==f.sector) return false;
      if (d.max < f.min) return false;
      if (d.min > f.max) return false;
      if (f.cti && d.cti!==f.cti) return false;
      if (f.instr.length && !f.instr.some(x=>d.accepts.includes(x))) return false;
      return true;
    };
    const currentMatches = ()=> window.DATA.filter(d=>passes(d,getFilters()));

    let previewMode = 'suggested';
    const updateSeg = () => {
      const sug = $('#segSuggested'), lat = $('#segLatest');
      const sugActive = previewMode==='suggested';
      if (sug){ sug.classList.toggle('active',sugActive); sug.setAttribute('aria-selected', String(sugActive)); }
      if (lat){ lat.classList.toggle('active',!sugActive); lat.setAttribute('aria-selected', String(!sugActive)); }
    };
    on('#segSuggested','click', ()=>{ previewMode='suggested'; updateSeg(); updateAll(); });
    on('#segLatest','click', ()=>{ previewMode='latest'; updateSeg(); updateAll(); });

    function makeMiniCard(d, opts={showFit:true, showFresh:false}){
      const div = document.createElement('div');
      div.className = 'card mini';
      div.style.marginTop = '10px';
      div.setAttribute('role','button');
      div.tabIndex = 0;
      div.innerHTML = `
        <div class="biz-head">
          <div>
            <div class="biz-title">${d.name}</div>
            <div class="muted">${d.country} · ${d.sector}</div>
            <div style="margin-top:6px">
              <span class="badge">${d.cti==='existence'?'Existence Only':d.cti==='verified'?'Verified':'Deep CTI'}</span>
              ${opts.showFit ? `<span class="badge green">${d.fit}</span>` : ``}
              ${opts.showFresh ? `<span class="badge">Verified ${d.freshnessDays}d ago</span>` : ``}
            </div>
          </div>
          <div style="text-align:right;min-width:160px">
            <div class="muted">Ticket</div>
            <div style="font-weight:800">${money(d.min)} – ${money(d.max)}</div>
          </div>
        </div>`;
      const open = ()=> openProfile(d);
      div.addEventListener('click', open);
      div.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); open(); }});
      return div;
    }

    function updateAll(){
      const list = currentMatches();
      const mini = $('#miniPreview'); if(!mini) return;
      $('#matchCountTop')  && ($('#matchCountTop').textContent  = list.length);
      $('#matchCountBottom') && ($('#matchCountBottom').textContent = list.length);
      mini.innerHTML = '';
      if(previewMode === 'latest'){
        const latest = [...window.DATA].sort((a,b)=> a.freshnessDays - b.freshnessDays).slice(0,3);
        latest.forEach(d => mini.appendChild(makeMiniCard(d, {showFit:false, showFresh:true})));
        return;
      }
      if(!list.length){
        mini.innerHTML = `<div class="hint">No matches yet. Try broadening filters.</div>`;
      } else {
        list.slice(0,3).forEach(d => mini.appendChild(makeMiniCard(d, {showFit:true, showFresh:false})));
      }
    }

    function renderResults(){
      const list = currentMatches();
      const root = $('#results'); if(!root) return;
      root.innerHTML = '';
      if (!list.length){
        root.innerHTML = `<div class="card"><strong>No matches (yet).</strong><div class="hint">Broaden ticket band, remove a constraint, or switch CTI depth.</div></div>`;
      } else {
        list.forEach(d=>{
          const card = document.createElement('div');
          card.className = 'card';
          card.style.cursor = 'pointer';
          card.setAttribute('role','button');
          card.tabIndex = 0;
          const open = ()=> openProfile(d);
          card.addEventListener('click', open);
          card.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); open(); }});
          card.innerHTML = `
            <div class="biz-head">
              <div>
                <div class="biz-title">${d.name}</div>
                <div class="muted">${d.country} · ${d.sector}</div>
                <div style="margin-top:8px">
                  <span class="badge">${d.cti==='existence'?'Existence Only':d.cti==='verified'?'Verified':'Deep CTI'}</span>
                  <span class="badge">Verified ${d.freshnessDays}d ago</span>
                  <span class="badge green">${d.fit}</span>
                </div>
                <div class="why">Why: ${d.why.join(' · ')}</div>
              </div>
              <div style="text-align:right;min-width:220px">
                <div class="muted">Ticket band</div>
                <div style="font-weight:800">${money(d.min)} – ${money(d.max)}</div>
                <div class="muted" style="margin-top:8px">Accepts</div>
                <div>${d.accepts.join(', ')}</div>
              </div>
            </div>`;
          root.appendChild(card);
        });
      }
      $('#showingText') && ($('#showingText').textContent = `Showing ${list.length} of ${list.length}`);
    }

    function openProfile(d){
      $('#profName') && ($('#profName').textContent = d.name);
      $('#profMeta') && ($('#profMeta').textContent = `${d.country} · ${d.sector} • ${d.cti==='existence'?'Existence Only':d.cti==='verified'?'Verified':'Deep CTI'}`);
      const linkRow = d.links?.profile
        ? `<a class="badge" href="${d.links.profile}">Open full profile</a>`
        : ``;
      $('#profBody') && ($('#profBody').innerHTML = `
        <div class="grid">
          <div class="col-12 card">
            <div class="biz-head">
              <div>
                <div class="muted">Ticket band</div>
                <div style="font-weight:800">${money(d.min)} – ${money(d.max)}</div>
                <div class="muted" style="margin-top:8px">Accepts</div>
                <div>${d.accepts.join(', ')}</div>
              </div>
              <div style="text-align:right;min-width:220px">
                <div class="badge green">${d.fit}</div>
                <div class="badge">Verified ${d.freshnessDays}d ago</div>
              </div>
            </div>
          </div>
          <div class="col-12 card">
            <h4 style="margin:0 0 6px">About</h4>
            <p>${d.about}</p>
            <h4 style="margin:12px 0 6px">Current need</h4>
            <p>${d.needs}</p>
            <div style="margin-top:10px">
              <a class="badge" href="${d.links.site || '#'}">Website</a>
              <a class="badge" href="${d.links.deck || '#'}">Deck</a>
              ${linkRow}
            </div>
          </div>
        </div>`);

      $('#searchStep')?.classList.add('hidden');
      $('#matchStep')?.classList.add('hidden');
      $('#profileStep')?.classList.remove('hidden');
      $('#profileStep')?.scrollIntoView({behavior:'smooth'});
    }

    const debounceUpdate = (fn => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),120); }; })(()=>updateAll());
    ['#q2','#country2','#sector2','#min2','#max2','#cti'].forEach(sel=>{
      on(sel,'input', debounceUpdate);
      on(sel,'change', debounceUpdate);
    });
    document.querySelectorAll('.instr').forEach(cb=> on(cb,'change', debounceUpdate));

    on('#toMatches','click', ()=>{ renderResults(); $('#searchStep')?.classList.add('hidden'); $('#matchStep')?.classList.remove('hidden'); $('#matchStep')?.scrollIntoView({behavior:'smooth'}); });
    on('#backToSearch','click', ()=>{ $('#matchStep')?.classList.add('hidden'); $('#searchStep')?.classList.remove('hidden'); $('#searchStep')?.scrollIntoView({behavior:'smooth'}); });
    on('#backFromProfile','click', ()=>{ $('#profileStep')?.classList.add('hidden'); $('#matchStep')?.classList.remove('hidden'); $('#matchStep')?.scrollIntoView({behavior:'smooth'}); });
    on('#continueCTA','click', ()=> alert('Next: view details / contact / save (stub)'));
    on('#doMatch','click', ()=>{ renderResults(); $('#searchStep')?.classList.add('hidden'); $('#matchStep')?.classList.remove('hidden'); $('#matchStep')?.scrollIntoView({behavior:'smooth'}); });

    document.addEventListener('DOMContentLoaded', ()=>{ updateAll(); });
  </script>
</body>
</html>
